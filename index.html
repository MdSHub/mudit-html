<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unicommerce Reports Downloader</title>
  <style>
    :root {
      --bg: radial-gradient(1200px 800px at 10% -10%, #dbeafe 0%, transparent 40%),
            radial-gradient(1000px 700px at 110% 10%, #fce7f3 0%, transparent 40%),
            linear-gradient(180deg, #0f172a 0%, #0b1220 100%);
      --card: #0b1220;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --accent: #60a5fa;
      --accent-2: #c084fc;
      --good: #22c55e;
      --bad: #ef4444;
      --ring: rgba(99, 102, 241, 0.4);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
      color: var(--text);
      background: var(--bg);
      background-attachment: fixed;
      display: grid;
      place-items: center;
      padding: 24px;
    }

    .wrap {
      width: 100%;
      max-width: 720px;
      display: grid;
      gap: 18px;
      animation: fadeIn 600ms ease both;
    }

    header h1 {
      margin: 0;
      font-size: clamp(24px, 4vw, 36px);
      letter-spacing: -0.02em;
    }
    header p { margin: 6px 0 0; color: var(--muted); }

    .card {
      background: color-mix(in hsl, var(--card) 85%, black 15%);
      border: 1px solid rgba(148, 163, 184, 0.12);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6), inset 0 1px 0 rgba(255,255,255,0.03);
    }

    .report-options {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(148,163,184,0.15);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      font-size: 15px;
      line-height: 1.6;
    }
    .report-options input[type="radio"] {
      accent-color: var(--accent);
      margin-right: 8px;
    }
    .date-selectors {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(148,163,184,0.15);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  font-size: 15px;
  line-height: 1.6;
}

.date-selectors input[type="date"] {
  background: rgba(255,255,255,0.05);
  color: var(--text);
  border: 1px solid rgba(148,163,184,0.25);
  border-radius: 8px;
  padding: 6px 10px;
  margin-left: 6px;
}


    .dropzone {
      border: 2px dashed rgba(148, 163, 184, 0.35);
      border-radius: 18px;
      padding: 28px;
      text-align: center;
      transition: border-color 160ms ease, background 160ms ease, transform 160ms ease;
      background: rgba(255, 255, 255, 0.02);
      cursor: pointer;
      position: relative;
      outline: none;
    }
    .dropzone:focus-visible { box-shadow: 0 0 0 3px var(--ring); }
    .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(96, 165, 250, 0.08);
      transform: translateY(-1px);
    }

    .dz-icon { opacity: 0.9; margin-bottom: 12px; }
    .dz-title { font-weight: 600; }
    .dz-sub { color: var(--muted); font-size: 14px; margin-top: 4px; }

    .actions { display: flex; gap: 12px; justify-content: center; margin-top: 14px; flex-wrap: wrap; }

    .button {
      appearance: none;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: linear-gradient(180deg, rgba(96,165,250,0.2), rgba(96,165,250,0.08));
      color: white;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
      backdrop-filter: blur(4px);
    }
    .button.secondary { background: transparent; }
    .button:disabled { opacity: 0.6; cursor: not-allowed; }
    .button:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(2,6,23,0.35); }

    .file-pill {
      display: inline-flex; align-items: center; gap: 8px;
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(148,163,184,0.08);
      padding: 8px 12px; border-radius: 999px; font-size: 14px; margin-top: 12px;
      max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .progress { height: 10px; background: rgba(148,163,184,0.15); border-radius: 999px; overflow: hidden; margin-top: 14px; }
    .progress .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width 120ms ease; }

    .status { margin-top: 14px; padding: 12px; border-radius: 12px; display: none; }
    .status.good { display: block; background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.35); }
    .status.bad  { display: block; background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.35); }

    footer { text-align: center; color: var(--muted); font-size: 12px; margin-top: 6px; }

    /* === Fullscreen Loader === */
    .overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      color: white;
      font-size: 18px;
      flex-direction: column;
    }
    .overlay.active { display: flex; animation: fadeIn 200ms ease both; }
    .spinner {
      width: 48px; height: 48px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* === Report History Table === */
.history {
  margin-top: 24px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(148,163,184,0.12);
  border-radius: 12px;
  padding: 16px;
}
.history h2 {
  font-size: 18px;
  color: var(--accent);
  margin-bottom: 12px;
}
#historyTable {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
#historyTable th, #historyTable td {
  padding: 8px 10px;
  border-bottom: 1px solid rgba(148,163,184,0.15);
}
#historyTable th {
  text-align: left;
  color: var(--muted);
}
#historyTable td {
  color: var(--text);
}
.status-cell.success { color: var(--good); font-weight: 600; }
.status-cell.failed { color: var(--bad); font-weight: 600; }
.download-link {
  color: var(--accent);
  text-decoration: none;
  font-weight: 500;
}
.download-link:hover { text-decoration: underline; }

  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <h1>Unicommerce Reports Downloader</h1>
      <p>Select a report type, upload your CSV, and get your processed file.</p>
    </header>

    <section class="card">
      <form id="uploadForm">
        <div class="report-options">
          <p><strong>Select Report Type:</strong></p>
          <label><input type="radio" name="reportType" value="putaway" required> Putaway Report</label><br>
          <label><input type="radio" name="reportType" value="sales"> Sales Order Report</label><br>
          <label><input type="radio" name="reportType" value="gatepass"> Gatepass Report</label><br>
          <label><input type="radio" name="reportType" value="inventory"> Inventory Snapshot</label>
        </div>

        <div class="dropzone" id="dropzone" tabindex="0">
          <svg class="dz-icon" width="56" height="56" viewBox="0 0 24 24" fill="none">
            <path d="M12 16V4m0 0l-3.5 3.5M12 4l3.5 3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <rect x="3" y="14" width="18" height="7" rx="2" stroke="currentColor" stroke-width="1.5"/>
          </svg>
          <div class="dz-title">Drop your CSV here</div>
          <div class="dz-sub">or</div>
          <div class="actions">
            <button class="button" id="browseBtn" type="button">Browse File</button>
            <button class="button secondary" id="uploadBtn" type="button" disabled>Upload</button>
          </div>
          <input id="fileInput" type="file" accept=".csv,text/csv" hidden />
          <div class="file-pill" id="filePill" style="display:none"></div>
          <div class="progress" id="progress" style="display:none"><div class="bar" id="progressBar"></div></div>
          <div class="status" id="status"></div>
        </div>
        <div class="date-selectors">
  <p><strong>Select Date Range:</strong></p>
  <label>
    Start Date:
    <input type="date" id="startDate" required>
  </label>
  <br>
  <label>
    End Date:
    <input type="date" id="endDate" required>
  </label>
</div>

      </form>
      <footer>CSV only. File uploads directly to your secure flow</footer>
      <!-- ===== Report History Section ===== -->
      <section class="history" id="historySection">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2>Recent Reports</h2>
          <button class="button secondary" id="refreshBtn" style="font-size:13px;padding:6px 10px;">üîÑ Refresh</button>
        </div>
      
        <table id="historyTable">
          <thead>
            <tr>
              <th>Report</th>
              <th>Status</th>
              <th>Created</th>
              <th>Duration</th>
              <th>Download</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5" style="text-align:center;color:#94a3b8;">Loading history...</td></tr>
          </tbody>
        </table>
      </section>
      

    </section>
  </main>

  <!-- üî• Fullscreen overlay -->
  <div class="overlay" id="overlay">
    <div class="spinner"></div>
    <div>Processing report... Please wait ‚è≥</div>
  </div>

  <script>
    const WEBHOOK_URL = 'https://stainably-hempy-leida.ngrok-free.dev/webhook/grade';

    const dz = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const filePill = document.getElementById('filePill');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progressBar');
    const statusEl = document.getElementById('status');
    const overlay = document.getElementById('overlay');
    let selectedFile = null;

    const resetUI = () => {
      progress.style.display = 'none';
      progressBar.style.width = '0%';
      statusEl.style.display = 'none';
      statusEl.textContent = '';
      statusEl.className = 'status';
    };

    const isCSV = (file) => /\.csv$/i.test(file.name);

    browseBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      resetUI();
      if (!file || !isCSV(file)) {
        statusEl.className = 'status bad';
        statusEl.textContent = 'Please select a valid .csv file.';
        statusEl.style.display = 'block';
        uploadBtn.disabled = true;
        return;
      }
      selectedFile = file;
      filePill.style.display = 'inline-flex';
      filePill.textContent = `${file.name} ‚Ä¢ ${(file.size/1024).toFixed(1)} KB`;
      uploadBtn.disabled = false;
    });

    uploadBtn.addEventListener('click', () => {
      const reportType = document.querySelector('input[name="reportType"]:checked')?.value;
      if (!reportType || !selectedFile) {
        statusEl.className = 'status bad';
        statusEl.textContent = 'Please select both report type and file.';
        statusEl.style.display = 'block';
        return;
      }

      resetUI();
      overlay.classList.add('active'); // Show overlay

      const form = new FormData();
      form.append('file', selectedFile);
      form.append('reportType', reportType);

      const start = document.getElementById('startDate').value;
const stop = document.getElementById('endDate').value;

if (start && stop) {
  const startUnix = Math.floor(new Date(start).getTime() / 1000);
  const stopUnix = Math.floor(new Date(stop).getTime() / 1000);
  form.append('start_date', startUnix);
  form.append('stop_date', stopUnix);
} else {
  statusEl.className = 'status bad';
  statusEl.textContent = 'Please select both start and end dates.';
  statusEl.style.display = 'block';
  overlay.classList.remove('active');
  return;
}

      const xhr = new XMLHttpRequest();
xhr.open('POST', WEBHOOK_URL, true);
xhr.responseType = 'json';

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          progressBar.style.width = (e.loaded / e.total * 100).toFixed(2) + '%';
        }
      };

      xhr.onload = () => {
  overlay.classList.remove('active');
  resetUI();

  if (xhr.status >= 200 && xhr.status < 300) {
    const res = xhr.response || {};
    const jobId = res.jobId || Math.random().toString(36).slice(2, 8);
    const msg = res.message || 'Report has been queued for processing.';

    statusEl.className = 'status good';
    statusEl.innerHTML = `‚úÖ ${msg}<br>Job ID: <strong>${jobId}</strong><br>
      Check <a href="#" onclick="loadHistory()">Recent Reports</a> for updates.`;
  } else {
    statusEl.className = 'status bad';
    statusEl.textContent = `‚ùå Upload failed (${xhr.status})`;
  }

  statusEl.style.display = 'block';
};



      xhr.onerror = () => {
        overlay.classList.remove('active');
        statusEl.className = 'status bad';
        statusEl.textContent = 'Network error while uploading.';
        statusEl.style.display = 'block';
      };

      xhr.send(form);
    });
    // === Load history ===
    async function loadHistory() {
  const tableBody = document.querySelector('#historyTable tbody');
  tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#94a3b8;">Loading history...</td></tr>';

  try {
    const res = await fetch('https://stainably-hempy-leida.ngrok-free.dev/webhook/check_job', {
      headers: {
        'ngrok-skip-browser-warning': 'true'
      }
    });
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#94a3b8;">No reports found.</td></tr>';
      return;
    }

    const rows = data.map(item => {
      const statusMap = {
        completed: { text: '‚úÖ Completed', cls: 'success' },
        processing: { text: '‚è≥ Processing', cls: '' },
        failed: { text: '‚ùå Failed', cls: 'failed' },
        queued: { text: 'üïì Queued', cls: '' },
      };
      const s = statusMap[item.status] || { text: item.status, cls: '' };
      const created = new Date(item.created_at).toLocaleString();
      const duration = item.duration_seconds ? `${item.duration_seconds}s` : '‚Äî';
      const download = item.s3_url
        ? `<a href="${item.s3_url}" target="_blank" class="download-link">Download</a>`
        : '‚Äî';
      return `
        <tr>
          <td>${item.report_type}</td>
          <td class="status-cell ${s.cls}">${s.text}</td>
          <td>${created}</td>
          <td>${duration}</td>
          <td>${download}</td>
        </tr>`;
    }).join('');
    tableBody.innerHTML = rows;
  } catch (err) {
    console.error('Failed to fetch history:', err);
    tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#ef4444;">Failed to load logs</td></tr>`;
  }
}

// setInterval(loadHistory, 30000); 

// Refresh button
document.getElementById('refreshBtn').addEventListener('click', loadHistory);

// Auto-load when page opens
window.addEventListener('DOMContentLoaded', loadHistory);

  </script>
  
  
</body>
</html>
